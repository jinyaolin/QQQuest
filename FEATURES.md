# QQQuest - 系統功能說明

> 完整的系統功能規格和使用指南

**版本**: v1.0.0  
**最後更新**: 2025-12-02

---

## 📋 目錄

- [系統概述](#系統概述)
- [核心功能](#核心功能)
- [頁面功能詳解](#頁面功能詳解)
- [技術特性](#技術特性)
- [使用場景](#使用場景)
- [功能對照表](#功能對照表)

---

## 系統概述

QQQuest 是一個專為 Meta Quest 設備設計的集中管理系統，提供以下核心能力：

- **📱 設備管理** - 連接、監控、控制多台 Quest 設備
- **🏠 房間管理** - 設備分組，批量操作
- **⚡ 動作管理** - 創建可重複使用的操作指令
- **📺 設備監看** - 實時畫面監控和遠程控制
- **⚙️ 系統設定** - 自訂參數和配置

---

## 核心功能

### 📱 設備管理

#### 設備連接

**手動添加設備**:
- 通過 IP 地址和端口連接（WiFi ADB）
- 支持設備代號（別名）和備註
- 自動驗證連接狀態
- 保存設備信息到資料庫

**設備狀態定義**:
- 🟢 **在線** (`ONLINE`) - 在 `adb devices` 列表中，且 `state == "device"`
- 🟠 **離線** (`OFFLINE`) - 在 `adb devices` 列表中，但 `state == "offline"`
- ⚫ **未連接** (`NOT_CONNECTED`) - 不在 `adb devices` 列表中

**自動狀態同步**:
- 頁面自動刷新同步狀態（每 3 秒）
- 根據 ADB 實際狀態更新
- 自動保存狀態變更到資料庫

#### 設備信息顯示

**設備卡片顯示**:
- 設備狀態圖示和代號
- 設備名稱和連接信息（IP:Port）
- 電池電量和充電狀態
- 設備溫度（帶顏色標示）
- 運作時間（uptime，小時和分鐘）
- 清醒/休眠狀態
- 屏幕開關狀態

**設備操作**:
- ⚡ **執行動作** - 選擇並執行預定義動作
- 📺 **監看設備** - 啟動 scrcpy 監看視窗
- 🔌 **中斷連線/重新連線** - 管理連接狀態
- ⚙️ **編輯設定** - 修改設備信息（代號、名稱、備註）
- 🗑️ **移除設備** - 從系統中移除設備（帶確認對話框）

#### 設備排序

**排序功能**:
- ⬆️ 向上移動按鈕
- ⬇️ 向下移動按鈕
- 自定義設備顯示順序
- 排序信息保存到資料庫
- JSON 文件按 `sort_order` 排序保存

---

### 🏠 房間管理

#### 房間操作

**房間 CRUD**:
- ➕ **新增房間** - 創建新房間（名稱、說明、最大設備數量）
- ✏️ **編輯房間** - 修改房間屬性
- 🗑️ **刪除房間** - 刪除房間（設備不會被刪除）

**房間卡片**:
- 顯示房間名稱和說明
- 設備數量統計（例如：3/5，不顯示"台"單位）
- 在線/離線/未連接設備統計
- 容量警告（房間已滿）
- 房間名稱可點擊（進入房間視圖）

#### 設備管理

**添加/移除設備**:
- 勾選式設備選擇
- 顯示設備當前所在房間
- 智能設備轉移（自動從舊房間移出）
- 容量檢查（不超過房間上限）
- 設備列表按 `sort_order` 排序

**房間視圖**:
- 點擊房間名稱進入房間視圖
- 顯示房間內所有設備卡片
- 支持所有設備管理功能（執行動作、監看、編輯等）
- 使用標籤頁分隔不同狀態的設備（🟢 在線 / 🟠 離線 / ⚫ 未連接）

#### 批量操作

**批量執行動作**:
- 選擇動作並執行到房間內所有在線設備
- 並發處理（使用 `ThreadPoolExecutor`）
- 執行進度和結果統計（成功/失敗數量）
- 詳細結果展示（每台設備的執行狀態）
- 自動更新動作執行統計

**房間重新連接**:
- 檢查房間內設備連接狀態
- 自動識別需要重新連接的設備（僅 `NOT_CONNECTED` 狀態）
- 並發連接（避免阻塞，10 倍性能提升）
- 跳過離線設備（`OFFLINE` 狀態）

---

### ⚡ 動作管理

#### 動作類型

**1. ☀️ 喚醒設備** (`WAKE_UP`)
- 喚醒休眠中的設備
- 可選驗證喚醒成功
- 使用 `input keyevent KEYCODE_WAKEUP`

**2. 😴 休眠設備** (`SLEEP`)
- 讓設備進入休眠
- 可選強制休眠（使用 SLEEP 鍵）
- 可選驗證休眠成功

**3. 🔌 保持喚醒** (`KEEP_AWAKE`)
- 設置設備在接電源時不進入深度睡眠
- 支持 4 種模式：
  - 模式 0: 禁用（預設值）
  - 模式 1: 僅 AC 充電時保持喚醒
  - 模式 2: 僅 USB 充電時保持喚醒
  - 模式 3: AC 和 USB 充電時保持喚醒（推薦）
- 使用 `settings put global stay_on_while_plugged_in {mode}`
- 執行後驗證設置是否成功

**4. 🚀 執行程式** (`LAUNCH_APP`)
- 啟動指定應用（package + activity）
- 可選停止已運行的實例
- 可選等待啟動完成
- 使用 `am start` 命令

**5. 🛑 關閉程式** (`STOP_APP`)
- 強制停止應用
- 支持 `force-stop` 和 `kill` 兩種方式
- 可選驗證關閉成功

**6. 🔄 重啟應用** (`RESTART_APP`)
- 關閉後重新啟動應用
- 可設定重啟延遲（0-10 秒）
- 使用 `am force-stop` + `am start`

**7. ⌨️ 發送按鍵** (`SEND_KEY`)
- 發送任意按鍵事件
- 支持常用按鍵快速選擇（HOME、BACK、MENU、POWER、VOLUME_UP/DOWN、WAKEUP、SLEEP）
- 可設定重複次數

#### 動作管理

**動作操作**:
- ➕ **新增動作** - 創建新動作（名稱、類型、參數）
- ✏️ **編輯動作** - 修改動作屬性
- 🗑️ **刪除動作** - 刪除動作（帶執行統計提醒）
- 📋 **複製動作** - 快速創建類似動作
- ▶️ **執行動作** - 選擇設備並執行

**動作執行**:
- 選擇目標設備執行動作
- 執行狀態即時反饋
- 執行統計（次數、成功率、最後執行時間）
- 自動更新動作統計

**搜索和篩選**:
- 關鍵字搜索動作（名稱和說明）
- 按類型篩選動作
- 實時搜索結果更新

**統計面板**:
- 動作總數
- 總執行次數
- 成功次數
- 整體成功率
- 個別動作成功率

---

### 📺 設備監看

#### scrcpy 集成

**實時監看**:
- 使用 scrcpy 實時監看設備畫面
- 低延遲（< 50ms）
- 高幀率（可達 60fps）
- 完整鍵盤滑鼠控制

**參數配置**:
- 視訊位元率（2M - 32M）
- 最大畫面寬度（480 - 3840）
- 最大幀率（0 - 120 FPS）
- 視窗大小和位置（X, Y, 寬度, 高度）
- 渲染驅動選擇
- 布林選項（保持清醒、顯示觸控、全螢幕等）
- 音訊轉發開關（預設禁用）

**預設設置**:
- 預設禁用音訊轉發（`--no-audio`）
- 避免關閉 Quest 設備聲音

---

### ⚙️ 系統設定

#### scrcpy 參數設定

**視訊參數**:
- 位元率（bitrate）
- 最大畫面寬度（max_size）
- 最大幀率（max_fps）

**視窗參數**:
- 視窗 X 位置
- 視窗 Y 位置
- 視窗寬度
- 視窗高度

**功能選項**:
- 保持清醒（stay_awake）
- 顯示觸控（show_touches）
- 全螢幕（fullscreen）
- 音訊轉發（enable_audio）

#### 截圖預覽參數設定

**預覽設置**:
- 啟用/禁用截圖預覽
- 更新頻率（1-10 秒）
- 預覽圖尺寸（寬度、高度）
- JPEG 品質（1-100）
- 快取開關

#### 設定管理

**設定操作**:
- 💾 **儲存設定** - 保存當前設定
- 📥 **匯入設定** - 從 JSON 文件導入
- 📤 **匯出設定** - 導出為 JSON 文件
- 🔄 **重置設定** - 恢復為預設值
- 🔄 **重新載入** - 從文件重新載入設定

---

## 頁面功能詳解

### 📱 設備管理頁面

**主要功能**:
1. 設備列表顯示（響應式網格佈局，每行 2-4 個卡片）
2. 新增設備對話框（IP、Port、代號、備註）
3. 設備卡片操作菜單
4. 設備狀態自動同步（每 3 秒）
5. 設備排序功能（向上/向下移動）

**設備卡片**:
- 統一高度（`min-height: 380px`）
- 底部內容對齊
- 狀態圖示和顏色區分
- 詳細狀態信息顯示
- 排序按鈕（緊湊設計，尺寸為 1/2）

**操作菜單**:
- ⚡ 執行動作
- 📺 監看設備
- 🔌 中斷連線/重新連線
- ⚙️ 編輯設定
- 🗑️ 移除設備

---

### 🏠 房間管理頁面

**主要功能**:
1. 房間列表顯示（每行 2 個卡片）
2. 新增房間對話框
3. 房間卡片操作菜單
4. 管理設備對話框（勾選式添加/移除）
5. 批量執行動作對話框
6. 房間重新連接對話框（並發處理）
7. 房間視圖（點擊房間名稱）

**房間卡片**:
- 統一高度（`min-height: 320px`）
- 房間名稱可點擊（進入房間視圖）
- 設備統計顯示（在線/離線/未連接）
- 容量警告

**操作菜單**:
- ⚡ 執行動作
- ➕ 管理設備
- 🔌 重新連接
- ✏️ 編輯房間
- 🗑️ 刪除房間

---

### ⚡ 動作管理頁面

**主要功能**:
1. 動作列表顯示（每行 2 個卡片）
2. 新增動作對話框（7 種動作類型）
3. 編輯動作對話框
4. 刪除動作確認對話框
5. 執行動作對話框（選擇設備）
6. 搜索和篩選功能
7. 統計面板

**動作卡片**:
- 動作圖示和名稱
- 動作類型標籤
- 執行統計（次數、成功率）
- 參數詳情（可展開）

**統計面板**:
- 動作總數
- 總執行次數
- 成功次數
- 整體成功率

---

### ⚙️ 系統設定頁面

**主要功能**:
1. scrcpy 參數配置（3 個標籤頁）
2. 截圖預覽參數配置
3. 設定匯入/匯出
4. 重置為預設值

**設定分類**:
- 視訊參數
- 視窗參數
- 功能選項
- 截圖參數

---

## 技術特性

### 並發處理

**批量操作優化**:
- 使用 `ThreadPoolExecutor` 進行並發處理
- 支持批量執行動作（`execute_action_batch`）
- 支持批量獲取狀態（`get_status_batch`）
- 支持批量連接設備（`connect_batch`）

**性能提升**:
- 10 台設備從 150 秒降至 15 秒（10 倍提升）
- 無響應設備不阻塞其他設備
- 支持進度回調

### 資料持久化

**資料庫**:
- 使用 TinyDB 進行輕量級資料持久化
- JSON 格式，易於閱讀和調試
- 自動排序保存（按 `sort_order`）

**資料文件**:
- `device_registry.json` - 設備資料（按 `sort_order` 排序）
- `action_registry.json` - 動作資料
- `room_registry.json` - 房間資料
- `user_config.json` - 用戶設定

### 狀態管理

**Session State**:
- 統一的初始化機制（`utils/init.py`）
- 頁面刷新後自動重新初始化
- 確保核心組件始終可用

**狀態同步**:
- 自動狀態同步（頁面刷新時）
- 根據 ADB 實際狀態更新
- 狀態變更自動保存

### 錯誤處理

**異常處理**:
- 完整的錯誤捕獲和記錄
- 用戶友好的錯誤提示
- 詳細的日誌記錄

**超時處理**:
- ADB 命令超時設置（15 秒）
- 超時後自動重試或跳過
- 不阻塞其他操作

---

## 使用場景

### 場景 1: 多設備管理

**需求**: 管理 10+ 台 Quest 設備

**解決方案**:
1. 在設備管理頁面添加所有設備
2. 創建房間對設備進行分組
3. 使用批量操作對房間內所有設備執行相同動作
4. 使用房間視圖查看和管理房間內設備

### 場景 2: 批量控制

**需求**: 同時對多台設備執行相同操作

**解決方案**:
1. 在動作管理頁面創建動作
2. 在房間管理中選擇房間
3. 執行動作到房間內所有在線設備
4. 系統會並發執行，快速完成（10 倍性能提升）

### 場景 3: 設備監控

**需求**: 實時監控設備狀態

**解決方案**:
1. 設備管理頁面自動刷新同步狀態
2. 查看設備卡片獲取詳細狀態信息
3. 使用 scrcpy 監看設備畫面
4. 設置保持喚醒避免設備進入深度睡眠

### 場景 4: 設備維護

**需求**: 定期維護和更新設備

**解決方案**:
1. 創建維護動作（重啟應用、清理緩存等）
2. 在房間管理中批量執行
3. 查看執行結果和統計
4. 根據結果進行後續操作

---

## 功能對照表

| 功能 | 狀態 | 版本 | 說明 |
|------|------|------|------|
| 設備管理 | ✅ | v0.1.0 | 添加、編輯、移除、排序 |
| 設備狀態監控 | ✅ | v0.1.0 | 電池、溫度、運作時間、清醒/休眠狀態 |
| scrcpy 監看 | ✅ | v0.1.0 | 實時畫面監控 |
| 系統設定 | ✅ | v0.1.0 | 參數配置 |
| 房間管理 | ✅ | v0.3.0 | 設備分組、批量操作 |
| 動作管理 | ✅ | v0.2.0 | 7 種動作類型 |
| 保持喚醒 | ✅ | v0.3.0 | 接電源時不進入深度睡眠 |
| 並發處理 | ✅ | v0.3.0 | 批量操作優化（10 倍性能提升） |
| 設備排序 | ✅ | v0.3.0 | 自定義顯示順序 |
| 房間視圖 | ✅ | v0.3.0 | 查看房間內所有設備 |
| 房間重新連接 | ✅ | v0.3.0 | 並發連接優化 |
| 時間碼同步 | ⏳ | 計劃中 | 未實現 |
| CUE 排程 | ⏳ | 計劃中 | 未實現 |

---

## 技術規格

### 系統要求

- **Python**: 3.9+
- **作業系統**: macOS / Linux / Windows
- **ADB**: Android Debug Bridge
- **scrcpy**: Screen copy tool

### 依賴套件

- `streamlit>=1.28.0` - Web 應用框架
- `pydantic>=2.0.0` - 資料驗證
- `tinydb>=4.8.0` - 資料持久化
- `loguru>=0.7.0` - 日誌工具
- `pillow>=10.0.0` - 圖像處理
- `streamlit-autorefresh>=0.0.1` - 自動刷新
- `adb-shell>=0.4.4` - ADB Python 封裝
- `python-dotenv>=1.0.0` - 環境變數管理

### 性能指標

- **單設備操作**: < 1 秒
- **10 台設備批量操作**: < 15 秒（並發處理）
- **狀態同步**: < 2 秒（批量查詢）
- **scrcpy 延遲**: < 50ms

---

## 限制和注意事項

### 功能限制

1. **僅支持 WiFi ADB** - USB 自動偵測已移除
2. **手動添加設備** - 需要手動輸入 IP 和 Port
3. **依賴外部工具** - 需要 ADB 和 scrcpy

### 平台限制

1. **macOS** - ✅ 已測試
2. **Linux** - ⚠️ 理論支持，待測試
3. **Windows** - ⚠️ 理論支持，待測試

### 性能限制

1. **單設備** - ✅ 性能優異
2. **3-5 設備** - ✅ 性能良好
3. **10+ 設備** - ⚠️ 可能需要調整刷新頻率

---

**最後更新**: 2025-12-02  
**版本**: v1.0.0  
**維護者**: QQQuest Team

# 系統設定功能說明

## 🎯 功能概述

新增「系統設定」頁面，允許使用者自訂 scrcpy 監看和截圖預覽的各項參數，提供更靈活的配置選項。

---

## ✨ 新增功能

### 1. **📺 scrcpy 監看設定**

可自訂以下參數：

#### **🎬 視訊設定**
- **視訊位元率**：2M / 4M / 8M / 16M / 32M
  - 較高的位元率提供更好的畫質
  - 預設：8M
  
- **最大畫面寬度**：480 - 3840 像素
  - 限制視訊寬度，0 表示無限制
  - 預設：1024
  
- **最大幀率**：0 - 120 FPS
  - 限制幀率，0 表示無限制
  - 預設：60
  
- **渲染驅動**：自動 / opengl / opengles2 / opengles / metal / software
  - 選擇渲染驅動
  - 預設：自動

#### **🪟 視窗設定**
- **視窗寬度**：自訂或自動
  - 可指定固定視窗寬度
  - 預設：自動
  
- **視窗高度**：自訂或自動
  - 可指定固定視窗高度
  - 預設：自動
  
- **視窗位置（X, Y）**：自訂或自動
  - 可指定視窗出現的座標
  - 預設：自動

#### **🔧 其他選項**
- **保持設備清醒**：監看時保持設備螢幕常亮（預設：開啟）
- **顯示觸控點**：在畫面上顯示觸控位置（預設：關閉）
- **全螢幕模式**：以全螢幕模式啟動（預設：關閉）
- **視窗置頂**：視窗永遠在最上層（預設：關閉）
- **關閉設備螢幕**：鏡像時關閉設備螢幕以節省電力（預設：關閉）

---

### 2. **📸 截圖預覽設定**

可自訂以下參數：

#### **⚙️ 基本設定**
- **啟用截圖預覽**：是否在設備卡片上顯示即時截圖
  - 預設：開啟
  
- **更新頻率**：1 / 2 / 3 / 5 / 7 / 10 秒
  - 截圖自動更新的時間間隔
  - 預設：5 秒
  
- **啟用快取**：減少 ADB 命令執行次數
  - 預設：開啟

#### **🖼️ 圖片設定**
- **預覽圖最大寬度**：100 - 800 像素
  - 預設：300
  
- **預覽圖最大高度**：100 - 600 像素
  - 預設：200
  
- **JPEG 品質**：10 - 100
  - 較高品質提供更清晰的圖片
  - 預設：80

---

### 3. **💾 匯入/匯出設定**

- **匯出設定**：將當前設定下載為 JSON 檔案
- **匯入設定**：從 JSON 檔案恢復設定
- **重置設定**：將所有設定恢復為預設值

---

## 📁 程式碼變更

### **新增檔案**

#### 1. `pages/4_⚙️_系統設定.py`
完整的系統設定頁面，包含：
- scrcpy 監看設定
- 截圖預覽設定
- 匯入/匯出設定

### **修改檔案**

#### 1. `config/settings.py`

**新增設定**：
```python
# scrcpy 監看設定
SCRCPY_CONFIG: Dict[str, Any] = {
    "bitrate": "8M",
    "max_size": 1024,
    "max_fps": 60,
    "window_width": None,
    "window_height": None,
    "window_x": None,
    "window_y": None,
    "stay_awake": True,
    "show_touches": False,
    "fullscreen": False,
    "always_on_top": False,
    "turn_screen_off": False,
    "render_driver": None,
}

# 截圖預覽設定
SCREENSHOT_CONFIG: Dict[str, Any] = {
    "enabled": True,
    "update_interval": 5,
    "max_width": 300,
    "max_height": 200,
    "quality": 80,
    "cache_enabled": True,
}
```

**新增函式**：
```python
def get_user_config() -> Dict[str, Any]:
    """獲取使用者自訂設定"""
    
def save_user_config(config: Dict[str, Any]) -> bool:
    """儲存使用者自訂設定"""
```

#### 2. `core/adb_manager.py`

**修改方法**：
```python
def start_scrcpy(
    self, 
    device: str, 
    window_title: Optional[str] = None,
    options: Optional[Dict[str, Any]] = None
) -> Tuple[bool, str]:
    """
    啟動 scrcpy 監看設備
    - 自動載入使用者設定
    - 支援更多 scrcpy 參數
    """
```

**新增方法**：
```python
def get_screenshot(
    self,
    device: str,
    max_width: Optional[int] = None,
    max_height: Optional[int] = None,
    quality: int = 80
) -> Optional[bytes]:
    """
    獲取設備截圖（PNG 格式）
    - 支援自動調整大小
    - 支援品質設定
    """
```

#### 3. `requirements.txt`

**新增依賴**：
```
# 圖像處理
pillow>=10.0.0
```

---

## 🎮 使用方式

### **1. 進入系統設定頁面**

在側邊欄點擊「⚙️ 系統設定」或直接訪問該頁面。

### **2. 調整 scrcpy 設定**

1. 切換到「📺 scrcpy 監看設定」標籤
2. 調整視訊、視窗和其他選項
3. 點擊「💾 儲存設定」

**下次點擊「📺 監看設備」時，將使用您的自訂設定！**

### **3. 調整截圖預覽設定**

1. 切換到「📸 截圖預覽設定」標籤
2. 調整更新頻率和圖片大小
3. 點擊「💾 儲存設定」

**設備卡片上的截圖預覽將使用您的自訂設定！**

### **4. 備份/恢復設定**

**匯出設定**：
1. 切換到「💾 匯入/匯出」標籤
2. 點擊「📥 下載設定檔」
3. 儲存 JSON 檔案

**匯入設定**：
1. 切換到「💾 匯入/匯出」標籤
2. 上傳先前匯出的 JSON 檔案
3. 點擊「🔄 套用匯入的設定」

---

## 🔍 技術細節

### **設定儲存位置**

使用者設定儲存在：
```
data/user_config.json
```

### **設定格式**

```json
{
  "scrcpy": {
    "bitrate": "8M",
    "max_size": 1024,
    "max_fps": 60,
    ...
  },
  "screenshot": {
    "enabled": true,
    "update_interval": 5,
    "max_width": 300,
    ...
  }
}
```

### **載入邏輯**

1. 系統預設設定定義在 `config/settings.py`
2. 啟動時載入 `data/user_config.json`
3. 使用者設定會覆蓋系統預設設定
4. 若設定檔不存在或損壞，使用系統預設設定

### **scrcpy 命令範例**

**使用預設設定**：
```bash
scrcpy -s 192.168.1.100:5555 --window-title "設備名稱 - QQQuest" \
  -b 8M -m 1024 --stay-awake
```

**使用自訂設定**（例如：16M 位元率，1920 寬度，60 FPS，顯示觸控）：
```bash
scrcpy -s 192.168.1.100:5555 --window-title "設備名稱 - QQQuest" \
  -b 16M -m 1920 --max-fps 60 --show-touches --stay-awake
```

### **截圖處理流程**

1. 執行 `adb -s {device} shell screencap -p`
2. 獲取 PNG 格式圖像數據
3. 如果設定了最大寬度/高度，使用 PIL 調整大小
4. 保持長寬比例
5. 返回處理後的圖像數據

---

## 📊 效能影響

### **scrcpy 設定**

| 設定 | 低 | 中 | 高 |
|------|----|----|-----|
| **位元率** | 2M | 8M | 16M+ |
| **解析度** | 720 | 1024 | 1920+ |
| **幀率** | 30 | 60 | 120 |
| **CPU 占用** | 低 | 中 | 高 |
| **頻寬占用** | 低 | 中 | 高 |
| **畫質** | 普通 | 良好 | 優秀 |

### **截圖預覽設定**

| 更新頻率 | ADB 命令次數/分鐘 | 效能影響 |
|---------|------------------|---------|
| 1 秒 | 60 | 高 |
| 3 秒 | 20 | 中 |
| 5 秒 | 12 | 低 |
| 10 秒 | 6 | 極低 |

**建議**：
- 本地網路：可使用較高設定（5 秒更新，1024 寬度）
- 遠端網路：使用較低設定（10 秒更新，720 寬度）
- 多設備（10+ 台）：延長更新頻率（7-10 秒）

---

## ⚠️ 注意事項

### **scrcpy 設定**

1. **位元率過高**：可能導致網路延遲或卡頓
2. **解析度過高**：會增加 CPU 和網路負擔
3. **渲染驅動**：如遇到顯示問題，可嘗試更換驅動
4. **視窗位置**：確保座標在螢幕範圍內

### **截圖預覽設定**

1. **更新頻率過快**：會增加 ADB 命令執行次數，可能影響效能
2. **圖片尺寸過大**：會增加網路傳輸量和記憶體占用
3. **品質設定**：對 PNG 格式無影響（截圖使用 PNG）
4. **快取**：建議保持啟用以提升效能

---

## 🐛 疑難排解

### **問題 1：設定沒有生效**

**解決方法**：
1. 確認已點擊「💾 儲存設定」
2. 重新啟動要監看的設備
3. 檢查 `data/user_config.json` 是否存在

### **問題 2：scrcpy 無法啟動**

**解決方法**：
1. 檢查 scrcpy 是否已安裝：`scrcpy --version`
2. 嘗試在終端機手動執行 scrcpy 命令
3. 檢查日誌檔 `logs/app.log` 查看錯誤訊息
4. 嘗試重置設定為預設值

### **問題 3：截圖預覽不顯示**

**解決方法**：
1. 確認「啟用截圖預覽」已勾選
2. 確認設備在線
3. 檢查是否安裝 Pillow：`pip install pillow`
4. 查看日誌檔確認錯誤訊息

### **問題 4：設定檔損壞**

**解決方法**：
1. 刪除 `data/user_config.json`
2. 重新啟動應用程式
3. 系統會自動使用預設設定

---

## 📝 待辦事項

- [ ] 在設備管理頁面整合截圖預覽功能
- [ ] 添加預設配置模板（低效能/平衡/高品質）
- [ ] 支援多組配置切換
- [ ] 添加配置驗證機制
- [ ] 支援更多 scrcpy 進階參數

---

## 📅 更新日期

**2025-12-01**

---

## ✅ 總結

系統設定功能提供了：

1. ✅ **完整的 scrcpy 參數自訂**（位元率、解析度、幀率、視窗等）
2. ✅ **靈活的截圖預覽配置**（更新頻率、圖片尺寸、品質）
3. ✅ **設定備份/恢復功能**（匯入/匯出 JSON）
4. ✅ **直觀的圖形化設定介面**（無需編輯設定檔）

**讓使用者可以根據自己的需求和硬體條件，調整最適合的參數！**


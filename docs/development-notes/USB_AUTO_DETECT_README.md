# 📱 USB 自動偵測說明

## ✅ 系統運作正常

根據日誌分析，USB 自動偵測功能**正常運作中**！

### 📊 日誌證據

```
2025-11-30 23:46:00 | INFO - 發現設備: 2G97C5ZH4Z00CC (usb)
2025-11-30 23:46:00 | INFO - 發現新設備: 2G97C5ZH4Z00CC  ✅
2025-11-30 23:46:00 | INFO - UI: 發現新設備 2G97C5ZH4Z00CC  ✅
```

系統已經：
- ✅ 偵測到 USB 設備
- ✅ 識別為新設備（Quest 3）
- ✅ 觸發 UI 回調

---

## ⚠️ 為什麼沒有立即看到對話框？

這是 **Streamlit 的限制**，不是 Bug！

### 原理說明

1. **USB 監控器在背景執行緒運行**
   - 每 3 秒掃描一次 `adb devices`
   - 發現新設備時更新 `session_state`

2. **Streamlit 不會立即重新渲染**
   - 背景執行緒無法觸發頁面重新渲染
   - 必須等待：
     - 自動刷新（每 3 秒）
     - 或使用者互動（點擊按鈕等）

3. **對話框顯示時機**
   - USB 插入 → 0-3 秒內偵測到
   - 等待頁面刷新 → 再 0-3 秒
   - **總計：3-6 秒後顯示對話框**

---

## 🎯 正確的測試步驟

### 測試 1：USB 新設備偵測

1. **確保在「設備管理」頁面**
   ```bash
   # 日誌會顯示：USB 監控器已啟動
   ```

2. **拔掉所有 Quest USB 線**
   ```bash
   # 等待 3 秒讓系統更新
   ```

3. **插入新的 Quest（之前沒連接過的）**
   ```bash
   # 在 Quest 中允許 USB 除錯
   ```

4. **觀察頁面右上角狀態**
   ```
   🔄 監控中 (1 台)  ← 設備數會增加
   ```

5. **等待 3-6 秒**
   - 頁面會自動刷新
   - 如果是新設備 → 彈出「偵測到新設備」對話框
   - 如果是已知設備 → 顯示「設備 XX 已自動連接」

### 測試 2：已知設備自動連接

1. 移除設備後重新插入
2. 系統會自動識別序號
3. 自動執行 `adb tcpip 5555`
4. 自動連接 WiFi
5. 顯示成功通知

---

## 🔍 如何確認系統正在運作？

### 方法 1：查看頁面指示器

在「設備管理」頁面右上角：
- `🔄 等待設備...` - 監控中，無設備
- `🔄 監控中 (1 台)` - 偵測到 1 台設備
- `🔄 監控中 (2 台)` - 偵測到 2 台設備

### 方法 2：查看即時日誌

```bash
# 開啟另一個終端視窗
cd /Users/jinyaolin/QQquest
tail -f logs/qqquest_$(date +%Y-%m-%d).log | grep "發現\|USB\|new_device"
```

插入 USB 後，你會立即看到：
```
INFO - 發現設備: 2G97C5ZH4Z00CC (usb)
INFO - 發現新設備: 2G97C5ZH4Z00CC
INFO - UI: 發現新設備 2G97C5ZH4Z00CC
```

### 方法 3：檢查 ADB

```bash
# 在終端執行
adb devices

# 應該顯示
List of devices attached
2G97C5ZH4Z00CC         device
```

---

## 💡 如果對話框沒有出現

### 檢查清單

1. **確認在「設備管理」頁面**
   - 只有在這個頁面 USB 監控才會啟動
   - 側邊欄點擊「📱 設備管理」

2. **確認設備已被 ADB 識別**
   ```bash
   adb devices
   # 應該看到設備序列號
   ```

3. **確認在 Quest 中允許 USB 除錯**
   - Quest 應該彈出提示
   - 勾選「一律允許」並確認

4. **等待足夠時間**
   - 至少等待 6-10 秒
   - 頁面會自動刷新

5. **查看日誌**
   ```bash
   tail -50 logs/qqquest_*.log | grep "發現"
   ```

6. **手動觸發刷新**
   - 點擊頁面上任何按鈕
   - 或按 F5 重新載入

---

## 🛠️ 手動觸發（如果自動失敗）

如果等待後仍沒有對話框，可以：

### 方法 1：查看設備序號

```bash
adb devices

# 複製序號，例如：2G97C5ZH4Z00CC
```

### 方法 2：使用「新增設備」功能

1. 在設備管理頁面點擊「➕ 新增設備」
2. 先執行：
   ```bash
   adb -s 2G97C5ZH4Z00CC tcpip 5555
   # 等待 2 秒
   adb -s 2G97C5ZH4Z00CC shell ip addr show wlan0 | grep "inet "
   # 取得 IP 地址
   ```
3. 在對話框輸入 IP 和代號
4. 點擊連線

---

## 📊 效能考量

### 為什麼是 3 秒掃描間隔？

- ⚡ 更快（1 秒）：
  - 優點：反應更靈敏
  - 缺點：CPU 使用率高，電池消耗快
  
- 🐢 更慢（5 秒）：
  - 優點：省資源
  - 缺點：使用者等待時間長

- ✅ **3 秒（目前設定）**：
  - 平衡點
  - 反應時間可接受
  - 資源使用合理

### 可以調整嗎？

可以！編輯 `config/settings.py`：

```python
# 改為 1 秒掃描（更快）
ADB_SCAN_INTERVAL = 1

# 改為 5 秒掃描（更省）
ADB_SCAN_INTERVAL = 5
```

重新啟動應用即可生效。

---

## 🎓 技術細節

### Streamlit 多執行緒限制

Streamlit 是單執行緒框架：
- ❌ 背景執行緒**無法**直接更新 UI
- ❌ 背景執行緒**無法**觸發 `st.rerun()`
- ✅ 只能更新 `session_state`
- ✅ 等待下次渲染週期

### 我們的解決方案

1. **自動刷新**：`streamlit-autorefresh` 每 3 秒刷新
2. **狀態指示器**：顯示監控中的設備數量
3. **日誌記錄**：完整記錄所有事件
4. **回調機制**：USB 監控器 → session_state → UI

### 未來改進

可能的優化方向：
1. WebSocket 即時通知
2. Server-Sent Events (SSE)
3. 改用 FastAPI + React（完全即時）

---

## ✅ 結論

**系統運作正常！** 只是因為 Streamlit 的機制，對話框會延遲 3-6 秒出現。

### 記住三點：

1. 💡 **插入 USB 後等待 6-10 秒**
2. 👀 **注意右上角的設備數量**
3. 📊 **查看日誌確認偵測成功**

---

## 🐛 如果還是有問題

請提供以下資訊：

1. **日誌片段**
   ```bash
   tail -100 logs/qqquest_*.log | grep "發現"
   ```

2. **ADB 設備列表**
   ```bash
   adb devices
   ```

3. **設備註冊表**
   ```bash
   cat data/device_registry.json
   ```

4. **具體步驟**
   - 什麼時候插入 USB？
   - 等了多久？
   - 看到什麼訊息？

---

**USB 自動偵測功能正常運作中！** 🎉


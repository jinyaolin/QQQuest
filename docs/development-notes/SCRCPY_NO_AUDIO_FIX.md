# scrcpy 音訊設定修復

## 🎯 問題描述

**問題**：scrcpy 預設會嘗試轉發設備音訊到電腦，但這會導致 Quest 的內建聲音被關閉。

**影響**：
- 使用者在 Quest 中聽不到聲音
- 音訊被重定向到電腦
- 影響 VR 體驗

## ✅ 解決方案

在 scrcpy 啟動命令中添加 `--no-audio` 選項，禁用音訊轉發。

## 🔧 已實現的修改

### 1. **core/adb_manager.py**

#### **修改：`start_scrcpy()` 方法**

在構建 scrcpy 命令時，添加了音訊控制邏輯：

```python
# 音訊設定 - 預設禁用以避免關閉 Quest 的聲音
if not final_options.get('enable_audio', False):
    cmd.append('--no-audio')
```

**邏輯**：
- 預設：`enable_audio = False` → 添加 `--no-audio` 參數
- 如果用戶明確設定 `enable_audio = True`，則不添加 `--no-audio`

#### **更新：docstring**

添加了 `enable_audio` 選項說明：
```python
- enable_audio: 啟用音訊轉發（預設 False，避免關閉 Quest 聲音）
```

---

### 2. **config/settings.py**

#### **新增：預設配置**

在 `SCRCPY_CONFIG` 中添加：

```python
SCRCPY_CONFIG: Dict[str, Any] = {
    # ... 其他選項
    "enable_audio": False,     # 啟用音訊轉發（預設關閉以避免關閉 Quest 聲音）
    # ...
}
```

**預設值**：`False` - 禁用音訊轉發，保持 Quest 內建聲音正常。

---

### 3. **pages/4_⚙️_系統設定.py**

#### **新增：UI 控制**

在「🔧 其他選項」部分添加了音訊轉發開關：

```python
scrcpy_config['enable_audio'] = st.checkbox(
    "啟用音訊轉發",
    value=scrcpy_config.get('enable_audio', False),
    help="轉發設備音訊到電腦（⚠️ 可能會關閉 Quest 的內建聲音）"
)
```

**位置**：「scrcpy 監看設定」標籤 > 「其他選項」 > 第三欄

**說明**：
- 預設：未勾選（禁用音訊轉發）
- 勾選後：啟用音訊轉發（會關閉 Quest 聲音）
- 有警告提示：⚠️ 可能會關閉 Quest 的內建聲音

---

## 📊 行為對比

### **修改前**

```bash
scrcpy -s 192.168.1.100:5555 -b 8M -m 1024 --stay-awake
```

**結果**：
- ❌ Quest 內建聲音被關閉
- ✅ 音訊轉發到電腦（但用戶可能不想要）

---

### **修改後（預設）**

```bash
scrcpy -s 192.168.1.100:5555 -b 8M -m 1024 --stay-awake --no-audio
```

**結果**：
- ✅ Quest 內建聲音正常
- ❌ 音訊不轉發到電腦

---

### **修改後（啟用音訊）**

如果用戶在系統設定中勾選「啟用音訊轉發」：

```bash
scrcpy -s 192.168.1.100:5555 -b 8M -m 1024 --stay-awake
```

**結果**：
- ❌ Quest 內建聲音被關閉
- ✅ 音訊轉發到電腦

---

## 🎮 使用方式

### **方式 1：使用預設設定（推薦）**

不需要任何操作，預設就會禁用音訊轉發。

1. 前往「📱 設備管理」
2. 點擊「📺 監看設備」
3. scrcpy 啟動時會自動添加 `--no-audio` 參數
4. ✅ Quest 聲音正常

---

### **方式 2：啟用音訊轉發（特殊需求）**

如果您需要將 Quest 的音訊轉發到電腦：

1. 前往「⚙️ 系統設定」
2. 切換到「📺 scrcpy 監看設定」標籤
3. 在「🔧 其他選項」部分，勾選「啟用音訊轉發」
4. 點擊「💾 儲存設定」
5. 之後啟動監看時，音訊會轉發到電腦

**注意**：⚠️ 這會關閉 Quest 的內建聲音！

---

## 🧪 測試

### **測試 1：驗證預設禁用音訊**

```bash
cd /Users/jinyaolin/QQquest
./run.sh
```

1. 前往「📱 設備管理」
2. 點擊任一在線設備的「📺 監看設備」
3. 檢查終端機日誌，應該看到：
   ```
   啟動 scrcpy: scrcpy -s 192.168.1.100:5555 ... --no-audio
   ```
4. **驗證**：Quest 的聲音應該正常

---

### **測試 2：驗證音訊轉發開關**

1. 前往「⚙️ 系統設定」
2. 勾選「啟用音訊轉發」
3. 點擊「💾 儲存設定」
4. 返回「📱 設備管理」
5. 點擊「📺 監看設備」
6. 檢查終端機日誌，應該**不包含** `--no-audio`
7. **驗證**：Quest 的聲音應該被關閉，音訊轉發到電腦

---

## 📝 技術細節

### **scrcpy 音訊參數**

```bash
--no-audio              # 禁用音訊轉發
--audio-codec=opus      # 指定音訊編碼（不加 --no-audio 時有效）
--audio-bit-rate=128K   # 音訊位元率（不加 --no-audio 時有效）
```

### **預設行為**

- scrcpy 預設會嘗試轉發音訊
- 音訊轉發會佔用設備的音訊輸出
- 對於 Quest 設備，這會導致內建聲音被關閉

### **為什麼不直接移除音訊功能？**

1. **靈活性**：某些用戶可能需要音訊轉發（例如錄影、演示）
2. **完整性**：保留所有 scrcpy 功能的配置選項
3. **可控性**：通過 UI 開關讓用戶自主選擇

---

## ⚠️ 注意事項

### **1. Quest 設備的特性**

Quest 是獨立的 VR 設備，音訊通常應該從頭戴設備輸出：
- 內建揚聲器
- 或連接的耳機

### **2. 音訊轉發的使用場景**

音訊轉發適合以下場景：
- ✅ 錄製演示影片（需要捕獲設備音訊）
- ✅ 遠端支援（需要聽到設備的聲音）
- ✅ 調試音訊相關問題

### **3. 預設禁用的原因**

對於 Quest 設備管理系統：
- 大多數時候不需要音訊轉發
- 保持 Quest 內建聲音是更好的預設體驗
- 避免用戶困惑（為什麼沒聲音？）

---

## 🔄 未來改進（可選）

### **改進 1：自動偵測設備類型**

```python
# 偵測設備是否為 Quest
if "quest" in device_model.lower():
    # Quest 設備預設禁用音訊
    default_enable_audio = False
else:
    # 其他設備預設啟用音訊
    default_enable_audio = True
```

### **改進 2：音訊品質設定**

如果啟用音訊，可添加：
- 音訊編碼選擇（opus / aac / raw）
- 音訊位元率（64K / 128K / 256K）

### **改進 3：音訊路由**

```python
--audio-output-buffer=50  # 音訊緩衝（降低延遲）
```

---

## 📅 更新日期

**2025-12-01**

## ✅ 總結

通過添加 `--no-audio` 選項：

1. ✅ **解決了 Quest 聲音被關閉的問題**
2. ✅ **保留了音訊轉發的功能**（通過設定開關）
3. ✅ **提供了清晰的 UI 控制**
4. ✅ **添加了警告提示**（避免用戶誤用）

**預設行為**：禁用音訊轉發，保持 Quest 內建聲音正常。

**用戶可選**：在系統設定中啟用音訊轉發。

---

**現在 scrcpy 監看功能不會影響 Quest 的聲音了！** 🎉🔊

